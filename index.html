<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkillSpark Hub</title>

<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
  Pi.init({ version: "2.0", sandbox: false }); // sandbox: false => Mainnet
</script>

<!-- Ø±Ø¨Ø· Ù…Ù„Ù CSS -->
<link rel="stylesheet" href="defaults.css">

</head>
<body>

<header>
  <h1>ğŸ“š SkillSpark Hub</h1>
  <p>ØªØ¹Ù„Ù… â€“ Ø´Ø§Ø±Ùƒ â€“ Ø·ÙˆÙ‘Ø± Ù…Ù‡Ø§Ø±ØªÙƒ</p>
</header>

<section class="section" id="roleBox"></section>

<section class="section" id="addBox" style="display:none">
  <div class="card">
    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ (Ù„Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†)</h3>
    <select id="lessonSection">
      <option>Ø§Ù„Ù„ØºØ§Øª</option>
      <option>Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
      <option>Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§</option>
    </select>
    <input id="lessonTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
    <input id="lessonVideo" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ (YouTube)">
    <input id="lessonImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©">
    <textarea id="lessonDesc" placeholder="Ø´Ø±Ø­ Ù…Ø®ØªØµØ±"></textarea>
    <button class="btn" onclick="addLesson()">Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³</button>
  </div>
</section>

<section class="section">
  <h3>ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
  <div id="sections"></div>
</section>

<footer>Â© 2025 SkillSpark Hub â€“ Pi Ready</footer>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
// ---------- Pi Authentication ----------
const scopes = ['payments','username'];
let userAuthToken = "";

function onIncompletePaymentFound(payment) { 
    console.log('incomplete payment found', payment);
    completePayment(payment.identifier, payment.transaction.txid);
}

Pi.authenticate(scopes, onIncompletePaymentFound).then(function(auth) {
  console.log("Ù…Ø±Ø­Ø¨Ø§! Ø£Ù†Øª Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù„Ù‰ Pi!");
  userAuthToken = auth.accessToken;
}).catch(function(error) {
  console.error(error);
});

// ---------- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ----------
let role = localStorage.getItem("role");
const sectionsData = { "Ø§Ù„Ù„ØºØ§Øª":[], "Ø§Ù„Ø¹Ù„ÙˆÙ…":[], "Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§":[] };

// ---------- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¯ÙˆØ± ----------
function initRole(){
  const box=document.getElementById("roleBox");
  if(role){
    box.innerHTML=`<div class="card">ğŸ‘¤ Ø¯ÙˆØ±Ùƒ: <strong>${role}</strong></div>`;
    if(role==="Ù…Ø¹Ù„Ù…") document.getElementById("addBox").style.display="block";
    return;
  }
  box.innerHTML=`
  <div class="card">
    <h3>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ</h3>
    <button class="btn" onclick="setRole('Ù…ØªØ¹Ù„Ù…')">ğŸ‘©â€ğŸ“ Ù…ØªØ¹Ù„Ù…</button>
    <button class="btn" onclick="setRole('Ù…Ø¹Ù„Ù…')">ğŸ‘¨â€ğŸ« Ù…Ø¹Ù„Ù‘Ù…</button>
  </div>`;
}
function setRole(r){ role=r; localStorage.setItem("role",r); initRole(); }

// ---------- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±ÙˆØ³ ----------
function aiExplain(text){ return `ğŸ¤– Ø´Ø±Ø­ Ù…Ø¨Ø³Ù‘Ø·:<br>${text}<br>âœ… ØªÙ…Ø±ÙŠÙ† Ø¹Ù…Ù„ÙŠ + ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±`; }
function addLesson(){
  const s=lessonSection.value, t=lessonTitle.value, d=lessonDesc.value;
  if(!t||!d) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  sectionsData[s].push({ t,d,v:lessonVideo.value,i:lessonImage.value,rate:0,flag:0,hidden:false, price:1 }); // price = 1 Pi
  save(); render();
  lessonTitle.value=lessonDesc.value=lessonVideo.value=lessonImage.value="";
}
function rateLesson(ls,val){ls.rate=val;save();render();}
function flagLesson(ls){ls.flag++;if(ls.flag>=3)ls.hidden=true;save();render();}
function save(){localStorage.setItem("lessons",JSON.stringify(sectionsData));}
function load(){Object.assign(sectionsData,JSON.parse(localStorage.getItem("lessons")||"{}"));}

// ---------- Ø§Ù„Ø¯ÙØ¹ ----------
async function payLesson(ls){
  if(!userAuthToken){ alert("Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹!"); return; }
  const paymentData = { amount: ls.price, memo: `Ø´Ø±Ø§Ø¡ Ø¯Ø±Ø³: ${ls.t}`, metadata:{} };
  const paymentCallbacks = {
    onReadyForServerApproval: async (paymentId)=>{
      console.log("Server Approval", paymentId);
      await axios.post('/payments/approve',{ paymentId }, { headers:{ Authorization: `Bearer ${userAuthToken}` } });
    },
    onReadyForServerCompletion: async (paymentId, txid)=>{
      console.log("Server Completion", paymentId, txid);
      await axios.post('/payments/complete',{ paymentId, txid }, { headers:{ Authorization: `Bearer ${userAuthToken}` } });
      alert(`ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³: ${ls.t} Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
    },
    onCancel: ()=>{ alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"); },
    onError: (err)=>{ console.error("Payment Error", err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹"); }
  };
  Pi.createPayment(paymentData, paymentCallbacks).then(p=>console.log("Payment started", p)).catch(e=>console.error(e));
}

function completePayment(paymentId, txid){
  console.log("Payment Complete:", paymentId, txid);
}

// ---------- Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ----------
function render(){
  const c=document.getElementById("sections");
  c.innerHTML="";
  Object.keys(sectionsData).forEach(sec=>{
    const a=document.createElement("div");
    a.className="accordion";
    a.innerHTML=`<div class="accordion-header"><strong>${sec}</strong><span>â¬‡ï¸</span></div><div class="accordion-content"></div>`;
    const cont=a.querySelector(".accordion-content");

    sectionsData[sec].forEach(ls=>{
      if(ls.hidden) return;
      const d=document.createElement("div");
      d.className="lesson";
      d.innerHTML=`
      <strong>${ls.t}</strong><br>
      ${ls.v?`<a href="${ls.v}" target="_blank">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</a>`:""}
      ${ls.i?`<img src="${ls.i}">`:""}
      <p>${ls.d}</p>
      <div class="ai-box">${aiExplain(ls.d)}</div>
      <div class="rate">
        â­ <span onclick="rateLesson(ls,1)">1</span>
        <span onclick="rateLesson(ls,2)">2</span>
        <span onclick="rateLesson(ls,3)">3</span>
        <span onclick="rateLesson(ls,4)">4</span>
        <span onclick="rateLesson(ls,5)">5</span>
        ğŸš© <span onclick="flagLesson(ls)">Ø¥Ø¨Ù„Ø§Øº</span>
        ğŸ’° <button class="btn" onclick="payLesson(ls)">Ø´Ø±Ø§Ø¡ Ø¨Ù€ Pi</button>
      </div>`;
      cont.appendChild(d);
    });

    a.querySelector(".accordion-header").onclick=()=>{
      const o=cont.style.display==="block";
      cont.style.display=o?"none":"block";
    };
    c.appendChild(a);
  });
}

load();
initRole();
render();
</script>

</body>
</html>
